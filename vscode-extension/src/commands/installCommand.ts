import * as vscode from 'vscode';
import { InstallationManager } from '../services/installationManager';
import { GitHubService } from '../services/githubService';
import { PlatformDetector } from '../services/platformDetector';
import { InstallationScope } from '../types/platform';
import { Logger } from '../utils/logger';

/**
 * Command handler for installing OLAF components
 */
export class InstallCommand {
    private readonly logger: Logger;
    private readonly installationManager: InstallationManager;
    private readonly githubService: GitHubService;
    private readonly platformDetector: PlatformDetector;

    constructor() {
        this.logger = Logger.getInstance();
        this.installationManager = InstallationManager.getInstance();
        this.githubService = GitHubService.getInstance();
        this.platformDetector = PlatformDetector.getInstance();
    }

    /**
     * Execute the install command
     */
    public async execute(): Promise<void> {
        try {
            this.logger.info('Starting OLAF installation...');

            // Show scope selection
            const scope = await this.selectInstallationScope();
            if (!scope) {
                return; // User cancelled
            }

            // Check if already installed in this scope
            const isInstalled = await this.installationManager.isInstalled(scope);
            if (isInstalled) {
                const overwrite = await vscode.window.showWarningMessage(
                    `OLAF is already installed in ${scope} scope. Do you want to overwrite it?`,
                    'Yes', 'No'
                );

                if (overwrite !== 'Yes') {
                    return;
                }
            }

            // Show progress
            await vscode.window.withProgress(
                {
                    location: vscode.ProgressLocation.Notification,
                    title: 'Installing OLAF',
                    cancellable: true
                },
                async (progress, token) => {
                    try {
                        // Check connectivity
                        progress.report({ increment: 10, message: 'Checking GitHub connectivity...' });
                        
                        const isConnected = await this.githubService.checkConnectivity();
                        if (!isConnected) {
                            throw new Error('Unable to connect to GitHub. Please check your internet connection.');
                        }

                        // Validate access for private repos
                        const config = vscode.workspace.getConfiguration('olaf');
                        const usePrivateRepo = config.get<boolean>('usePrivateRepository');
                        
                        if (usePrivateRepo) {
                            const validation = await this.githubService.validateAccess();
                            if (!validation.valid) {
                                throw new Error(validation.message);
                            }
                        }

                        // Get release based on default version preference
                        progress.report({ increment: 15, message: 'Fetching release information...' });
                        
                        const release = await this.githubService.getReleaseByVersionPreference();
                        const platform = await this.platformDetector.detectPlatform();
                        
                        // Find platform bundle
                        const bundleInfo = this.githubService.findPlatformBundle(release, platform.platform);
                        if (!bundleInfo) {
                            throw new Error(`No installation bundle found for your platform (${platform.platform})`);
                        }

                        // Download bundle
                        progress.report({ increment: 25, message: 'Downloading installation bundle...' });
                        
                        const bundleBuffer = await this.githubService.downloadBundle(
                            bundleInfo,
                            (downloadProgress) => {
                                progress.report({
                                    increment: 0,
                                    message: `Downloading... ${downloadProgress.toFixed(1)}%`
                                });
                            }
                        );

                        // Install bundle
                        progress.report({ increment: 25, message: 'Installing OLAF components...' });
                        
                        const installResult = await this.installationManager.installBundle(
                            bundleBuffer,
                            bundleInfo,
                            scope,
                            (installProgress, message) => {
                                progress.report({
                                    increment: 0,
                                    message
                                });
                            }
                        );

                        if (installResult.success) {
                            progress.report({ increment: 25, message: 'Installation completed!' });
                            
                            await vscode.window.showInformationMessage(
                                `OLAF installed successfully!\n\nLocation: ${installResult.installedPath}\nVersion: ${installResult.version}\nScope: ${installResult.scope}`,
                                'Show in Explorer'
                            ).then((action) => {
                                if (action === 'Show in Explorer') {
                                    vscode.commands.executeCommand('revealFileInOS', vscode.Uri.file(installResult.installedPath));
                                }
                            });

                            this.logger.info(`Installation completed successfully: ${installResult.installedPath}`);
                        } else {
                            throw new Error(installResult.error || 'Installation failed');
                        }

                    } catch (error) {
                        if (token.isCancellationRequested) {
                            this.logger.info('Installation cancelled by user');
                            return;
                        }
                        throw error;
                    }
                }
            );

        } catch (error) {
            this.logger.error('Installation failed', error as Error);
            
            await vscode.window.showErrorMessage(
                `Failed to install OLAF: ${(error as Error).message}`,
                'Show Logs'
            ).then((action) => {
                if (action === 'Show Logs') {
                    this.logger.show();
                }
            });
        }
    }

    private async selectInstallationScope(): Promise<InstallationScope | undefined> {
        const scopeItems: vscode.QuickPickItem[] = [
            {
                label: 'üë§ User',
                description: 'Install for current user across all workspaces',
                detail: 'Recommended for personal use',
                picked: true
            },
            {
                label: 'üìÅ Workspace',
                description: 'Install for current workspace only',
                detail: 'Shared with team members'
            },
            {
                label: 'üìÇ Project',
                description: 'Install for current project only',
                detail: 'Project-specific configuration'
            }
        ];

        const selectedItem = await vscode.window.showQuickPick(scopeItems, {
            title: 'Select Installation Scope',
            placeHolder: 'Choose where to install OLAF components',
            ignoreFocusOut: true
        });

        if (!selectedItem) {
            return undefined;
        }

        switch (selectedItem.label) {
            case 'üë§ User':
                return InstallationScope.USER;
            case 'üìÅ Workspace':
                return InstallationScope.WORKSPACE;
            case 'üìÇ Project':
                return InstallationScope.PROJECT;
            default:
                return InstallationScope.USER;
        }
    }
}
