# CVE Analysis Improved Workflow

> **Note:** All files referenced below are either prompts located in `[id:prompts_dir]` or tools located in `[id:tools_dir]`, as specified in the memory map file.
> The solution to analyze is in [path:core] and all new non-temporary created files are to be created in [id:findings_dir] folder.

# CVE Analysis Improved Workflow: Enhanced CVE Exposure Analysis with Additional Context

## Workflow Type
Sequential/Chained - Each step depends on the output of the previous step

## Workflow Overview
This workflow provides a comprehensive CVE exposure analysis with improved accuracy by including additional context sources and ensuring all required files are generated before proceeding to analysis.

## ⚠️ CRITICAL: Workflow Execution Validation Protocol

**MANDATORY FIRST ACTION**: Before executing any step, validate prerequisites using this exact sequence:

1. **Check Descriptor Status**: 
   - Read `[id:findings_dir]/cve-verifier/jal-dapi-ext-cve-tasklist-Descriptor.md`
   - Count pending CVEs requiring descriptors
   
2. **Check LLMs Files Status**:
   - Verify existence of `[id:findings_dir]/cve-verifier/llms-full.txt`
   - Verify existence of `[id:findings_dir]/cve-verifier/llms.txt`
   
3. **Determine Execution Step**:
   - IF descriptors pending > 0: Execute Step 1 (Extract Descriptors)
   - IF descriptors pending = 0 AND LLMs files missing: Execute Step 2 (LLMs Create)  
   - IF descriptors pending = 0 AND LLMs files exist: Execute Step 3 (CVE Analysis)

**FAILURE TO VALIDATE = WORKFLOW VIOLATION**

## Prerequisites
- BlackDuck CSV file available at output directory
- Output directory structure exists
- CVE identifiers available for analysis

## Input Requirements
- **Primary Input:** CVE identifiers requiring analysis
- **Secondary Inputs:** BlackDuck CSV file path, output directory path
- **Input Format:** CVE-YYYY-NNNNN format for CVE identifiers

## Output Specifications
- **Primary Output:** Complete CVE exposure analysis reports
- **Secondary Outputs:** CVE descriptors, consolidated code files, updated tasklists
- **Output Location:** [id:findings_dir]/cve-verifier/

## Workflow Steps

### Step 1: Extract CVE Descriptors
- **Prompt/Tool:** `[id:prompts_dir]/cve-verifier/generate-cve-descriptor.md`
- **Input:** CVE identifier, BlackDuck CSV path, output directory
- **Output:** CVE descriptor JSON files in individual-cve-descriptors/
- **Description:** Creates comprehensive CVE descriptor files with multi-source research
- **Condition to Execute:** Descriptor tasklist is absent OR shows there are still descriptors to create in the output directory
- **Validation:** CVE descriptor file exists and contains all required fields
- **⚠️ CRITICAL:** **MANDATORY SESSION HANDOFF** after each CVE completion - do not proceed to next CVE in same session

### Step 2: Execute LLMs Create Prompt
- **Prompt/Tool:** `[id:prompts_dir]/technical-writer/create-llms-files.md`
- **Input:** Codebase from [path:core]
- **Output:** llms-full.txt and llms.txt files in [id:findings_dir]/cve-verifier/
- **Description:** Consolidates codebase into searchable text files for pattern matching
- **Condition to Execute:** llms-full.txt AND llms.txt files are absent in [id:findings_dir]/cve-verifier/
- **Validation:** Both llms-full.txt and llms.txt files exist in [id:findings_dir]/cve-verifier/ and contain code content
- **⚠️ CRITICAL:** **MANDATORY SESSION HANDOFF** after completion - start new session and ask "cve exposure"

### Step 3: Generate CVE Analysis
- **Prompt/Tool:** `[id:prompts_dir]/cve-verifier/analyze-cve-exposure.md`
- **Input:** CVE identifier, BlackDuck CSV path, output directory, CVE descriptors, code files
- **Output:** CVE analysis JSON files in individual-cve-analyses/ (format: `{project-name}_{cve-id}-analysis.json`)
- **Description:** Executes comprehensive pattern-based code search and exposure analysis
- **Condition to Execute:** Analysis tasklist is absent OR shows there are still analyses to create in the output directory
- **Validation:** CVE analysis file exists with complete exposure assessment
- **⚠️ CRITICAL:** **MANDATORY SESSION HANDOFF** after completion - start new session and ask "cve exposure"

## Data Flow Diagram
```
[CVE IDs + BlackDuck CSV] → [Extract Descriptors] → [CVE Descriptors: {cve-id}-descriptor.json] → [Generate Code Files] → [llms-full.txt, llms.txt] → [CVE Analysis] → [Exposure Reports: {project-name}_{cve-id}-analysis.json]
```

## Error Handling
- **Step Failure:** Check tasklist status and condition validation before each step
- **Recovery:** Re-run failed step after verifying input conditions
- **Rollback:** Clean up partial outputs and restart from last successful step

## Completion Criteria
- [ ] All CVE descriptors generated for required CVEs
- [ ] Code consolidation files (llms-full.txt, llms.txt) created in [id:findings_dir]/cve-verifier/
- [ ] All CVE exposure analyses completed
- [ ] No critical errors encountered
- [ ] Tasklists updated to reflect completion status

## Execution Conditions Summary - STRICT SEQUENTIAL ORDER

**⚠️ CRITICAL: Steps MUST be executed in sequential order. Each step has mandatory prerequisites that MUST be validated before execution.**

### Step 1: Extract Descriptors
**Execute when ALL of the following are true:** 
- Descriptor tasklist file (`jal-dapi-ext-cve-tasklist-Descriptor.md`) is absent, OR
- Descriptor tasklist shows pending CVEs requiring descriptor creation
**BLOCKING CONDITION:** None - this is always the first step

### Step 2: Execute LLMs Create
**Execute when ALL of the following are true:**
- **PREREQUISITE**: All CVE descriptors are completed (descriptor tasklist shows 0 pending)
- Both `llms-full.txt` AND `llms.txt` files are absent in [id:findings_dir]/cve-verifier/
**BLOCKING CONDITION:** If any CVE descriptors are pending, MUST complete Step 1 first

### Step 3: Generate CVE Analysis  
**Execute when ALL of the following are true:**
- **PREREQUISITE 1**: All CVE descriptors are completed (descriptor tasklist shows 0 pending)
- **PREREQUISITE 2**: Both `llms-full.txt` AND `llms.txt` files exist in [id:findings_dir]/cve-verifier/
- Analysis tasklist file (`jal-dapi-ext-cve-tasklist-Analysis.md`) is absent, OR
- Analysis tasklist shows pending CVEs requiring exposure analysis
**BLOCKING CONDITION:** If descriptors are pending OR LLMs files are missing, MUST complete Steps 1 and 2 first

## Session Handoff Instructions

### After Step 1 (CVE Descriptor Creation):
1. **Start New Session** with the agent
2. **Ask**: `"cve exposure"`
3. Agent continues with Step 2 (LLMs Create) and Step 3 (CVE Analysis)

### After Step 2 (LLMs Create):
1. **Start New Session** with the agent  
2. **Ask**: `"cve exposure"`
3. Agent continues with Step 3 (CVE Analysis)

### After Step 3 (CVE Analysis):
1. **Start New Session** with the agent
2. **Ask**: `"cve exposure"`
3. Agent processes next CVE descriptor or completes workflow

## Next Steps
- Review generated CVE exposure reports
- Update security remediation priorities based on analysis results
- Execute remediation workflows for high-risk exposures
